# Installing Fedora 19 and freedreno on ifc6410

Instructions for installing Fedora 19 for the [ifc6410](http://inforcecomputing.com/blog/?p=27) pico-itx board.  These instructions will setup a Fedora filesystem on an external usb or sata disk for the ifc6410.  The same basic procedure should work for installation to an micro-sd card.  These instructions are not intended for installation to eMMC.

Note that these instructions are work-in-progress.

1. Download Fedora 19 [filesystem](https://dl.fedoraproject.org/pub/fedora-secondary/releases/test/19-Beta/Images/armhfp/Fedora-armhfp-19-Beta-1-sda.raw.xz), see https://fedoraproject.org/wiki/Architectures/ARM/F19/Beta
2. If you haven't already, install adb, fastboot, abootimg.  If your host is fedora, you can `sudo yum install android-tools`
2. While you are waiting for the downloads, boot android which came on the ifc6410 board, and save off the firmware:
 * connect to device: `adb shell`
 * on device, `cd /system/etc; tar czvf /data/firmware.tgz firmware`
 * back on host: `adb pull /data/firmware.tgz`
3. on your host, `xzcat Fedora-armhfp-19-Beta-1-sda.raw.xz > /dev/sdN`  (ie, `/dev/sdb`) to extract filesystem to usb or sata disk that you will use  
4. Use gparted or similar tool to resize the 3rd partition (rootfs) to the remaining size of the disk.  Or optionally create a 4th partition for `/home`.
 * NOTE: I had to `sync`, then remove and re-plug my USB disk before using gparted to resize.
4. mount to rootfs partition, /dev/sdN3, and extract the firmware we saved earlier:
 * `cd <mountpath>/lib; tar xzvf path/to/firmware.tgz`
5. unmount rootfs, plug drive to ifc6410, and boot fedora:
 * if android still running: `sudo fastboot reboot-bootloader`
 * once board is booted to fastboot, if you want to prevent android from booting automatically: `sudo fastboot erase boot`
 * if needed, download boot image (which contains zImage and initrd) here: [ifc6410-boot.img](http://people.freedesktop.org/~robclark/ifc6410-boot.img)
 * boot linux: `sudo fastboot boot ifc6410-boot.img`
 * TBD how to permanently flash ifc6410-boot.img?  It is too big for standard android boot partition size.
6. On board, login as root via serial terminal (initially no password).
7. Install X11 and gnome-desktop:
 * `yum install xorg-x11-server-Xorg xorg-x11-drv-evdev @gnome-desktop`
8. Additional things that I install for building freedreno, etc:  (not required)
 * `yum install @development-tools automake autoconf xorg-x11-server-devel libX11-devel libXext-devel libtool libXau-devel libXdamage-devel libXfixes-devel libXxf86vm-devel libxcb-devel pixman-devel xorg-x11-proto-devel xorg-x11-util-macros gcc-c++ vim strace git tig htop xterm`
 * `yum-builddep mesa-libGL mesa-libEGL`
9. xorg conf file, `/etc/X11/xorg.conf.d/90-freedreno.conf` (listed below)
10. If you don't feel like compiling libddrm/mesa/xf86-video-freedreno, then:
 * `cd / ; wget http://people.freedesktop.org/~robclark/ifc6410-freedreno.tgz ; tar xzvf ifc6410-freedreno.tgz`
11. Optionally, other stuff you might want to install:
 * https://github.com/freedreno/nexus4-fedora/raw/master/rootfs/08-es2gears.tar.gz
 * https://github.com/freedreno/nexus4-fedora/raw/master/rootfs/05-term-resize.tar.gz
12. Create a user: `adduser johndoe`
13. Start gdm: `systemctl start gdm`

### making a serial cable:
The debug UART (`console=ttyHSL0,115200,n8`) is the three pin header next to the DC power connector.  The inner pin is ground and the outer pins are RX and TX.  Which go to pins 2, 3, and 5 on an [rs232 db9 connector](http://www.arcelect.com/9_PIN_PIN_OUT.GIF).

### xorg conf file:

    Section "Device"
            Identifier      "Video Device"
            Driver          "freedreno"
            Option          "fb"              "/dev/fb0"
            # Temporary workaround, as hw cursor does not seem
            # to be working:
            Option           "SWCursor"        "true"
    #        Option          "Debug"           "true"
    EndSection
    Section "Screen"
            Identifier      "Screen"
            Monitor         "Monitor"
            Device          "Video Device"
    EndSection

### Compiling freedreno

These are the configure flags I use (and the order to build things):

**libdrm:**

    ./autogen.sh --prefix=/usr --enable-freedreno-experimental-api

**mesa:**

    ./autogen.sh --prefix=/usr --with-dri-drivers= --with-gallium-drivers=freedreno,swrast --with-egl-platforms=x11 --enable-gles2 --enable-gles1 --enable-debug --enable-gallium-egl --disable-gallium-llvm --enable-xa

**xf86-video-freedreno:**

    ./autogen.sh --prefix=/usr

### Making NetworkManager behave

If NetworkManager is eating a lot of CPU, it is probably being confused by the rmnet devices. Ask it to ignore them in /etc/NetworkManager/NetworkManager.conf :

    [keyfile]
    unmanaged-devices=interface-name:rmnet0;interface-name:rmnet1;interface-name:rmnet2;interface-name:rmnet3;interface-name:rmnet4;interface-name:rmnet5;interface-name:rmnet6;interface-name:rmnet7;interface-name:rmnet_smux0