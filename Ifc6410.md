# Installing Fedora and freedreno on ifc6410

Instructions for installing Fedora on the [ifc6410](http://inforcecomputing.com/blog/?p=27) pico-itx board.  These instructions will setup a Fedora filesystem on an external usb or sata disk for the ifc6410.  The same basic procedure should work for installation to an micro-sd card.  These instructions are not intended for installation to eMMC.

### Fedora 19

(see below for updated download links for Fedora 20 beta)

1. Download Fedora 19 [filesystem](https://dl.fedoraproject.org/pub/fedora-secondary/releases/test/19-Beta/Images/armhfp/Fedora-armhfp-19-Beta-1-sda.raw.xz), see https://fedoraproject.org/wiki/Architectures/ARM/F19/Beta
2. If you haven't already, install adb, fastboot, abootimg.  If your host is fedora, you can `sudo yum install android-tools`
2. While you are waiting for the downloads, boot android which came on the ifc6410 board, and save off the firmware:
 * connect to device: `adb shell`
 * on device, `cd /system/etc; tar czvf /data/firmware.tgz firmware`
 * back on host: `adb pull /data/firmware.tgz`
3. on your host, `xzcat Fedora-armhfp-19-Beta-1-sda.raw.xz > /dev/sdN`  (ie, `/dev/sdb`) to extract filesystem to usb or sata disk that you will use  
4. Use gparted or similar tool to resize the 3rd partition (rootfs) to the remaining size of the disk.  Or optionally create a 4th partition for `/home`.
 * NOTE: I had to `sync`, then remove and re-plug my USB disk before using gparted to resize.
4. mount to rootfs partition, /dev/sdN3, and extract the firmware we saved earlier:
 * `cd <mountpath>/lib; tar xzvf path/to/firmware.tgz`
5. unmount rootfs, plug drive to ifc6410, and boot fedora:
 * if android still running: `sudo fastboot reboot-bootloader`
 * once board is booted to fastboot, if you want to prevent android from booting automatically: `sudo fastboot erase boot`
 * if needed, download boot image (which contains zImage and initrd) here: [ifc6410-boot-drm.img](http://people.freedesktop.org/~robclark/f19/ifc6410-boot-drm.img)
 * boot linux: `sudo fastboot boot ifc6410-boot-drm.img`
    * if you are booting from sd card, override kernel cmdline:
        `sudo fastboot -c "console=ttyHSL0,115200,n8 console=/dev/console lpj=67677 root=/dev/mmcblk1p3" boot ifc6410-boot-drm.img`
 * to resize mmcblk0p7 (to be able boot without fastboot):
    * `sgdisk -d 7 /dev/mmcblk0`
    * `sgdisk -n 7:393216:524287 /dev/mmcblk0`
    * `sgdisk -c 7:boot /dev/mmcblk0`
    * `sgdisk -A 7:set:60 /dev/mmcblk0`
    * `sgdisk -t 7:ea00 /dev/mmcblk0`
 * after resizing mmcblk0p7 you can `fastboot flash boot ifc6410-boot-drm.img`
6. On board, login as root via serial terminal (initially no password).
7. Install X11 and gnome-desktop:
 * `yum install xorg-x11-server-Xorg xorg-x11-drv-evdev @gnome-desktop`
8. Additional things that I install for building freedreno, etc:  (not required)
 * `yum install @development-tools automake autoconf xorg-x11-server-devel libX11-devel libXext-devel libtool libXau-devel libXdamage-devel libXfixes-devel libXxf86vm-devel libxcb-devel pixman-devel xorg-x11-proto-devel xorg-x11-util-macros gcc-c++ vim strace git tig htop xterm`
 * `yum-builddep mesa-libGL mesa-libEGL`
9. xorg conf file, `/etc/X11/xorg.conf.d/90-freedreno.conf` (listed below)
10. If you don't feel like compiling libddrm/mesa/xf86-video-freedreno, then:
 * `cd / ; wget http://people.freedesktop.org/~robclark/f19/ifc6410-freedreno-drm.tgz ; tar xzvf ifc6410-freedreno-drm.tgz`
11. Optionally, other stuff you might want to install:
 * https://github.com/freedreno/nexus4-fedora/raw/master/rootfs/08-es2gears.tar.gz
 * https://github.com/freedreno/nexus4-fedora/raw/master/rootfs/05-term-resize.tar.gz
12. Create a user: `adduser johndoe`
13. Start gdm: `systemctl start gdm`

### Fedora 20

Follow the same instructions as above, but substitute:
* filesystem: [Fedora-Desktop-armhfp-20-Beta-5-sda.raw.xz](http://download.fedoraproject.org/pub/fedora/linux/releases/test/20-Beta/Images/armhfp/Fedora-Desktop-armhfp-20-Beta-5-sda.raw.xz)
* boot image: [ifc6410-boot-f20.img](http://people.freedesktop.org/~robclark/f20/ifc6410-boot-f20.img)
* prebuilt freedreno: [prebuilt-freedreno-f20.tgz](http://people.freedesktop.org/~robclark/f20/prebuilt-freedreno-f20.tgz)

NOTE that as of mesa 10.0 and libdrm 2.4.7 everything needed for a working accelerated gnome-shell desktop is upstream.  Once fedora moves to mesa 10.0 and xorg-x11-drv-freedreno is in fedora repositories, I'll probably stop providing prebuilt userspace binaries (since you'd be able to simply `yum install`).

### making a serial cable:
The debug UART (`console=ttyHSL0,115200,n8`) is the three pin header next to the DC power connector. RX/GND/TX are layed out as show below. These can be connected to a standard serial cable, pins 2, 3, and 5 on an [rs232 db9 connector](http://www.arcelect.com/9_PIN_PIN_OUT.GIF).

![Serial layout](http://people.collabora.com/~sjoerd/ifc6410-serial.png)

UPDATE: [UART cable instructions with pictures](http://mydragonboard.org/2013/rs-232-cable-for-ifc6410/)

NOTE: that it seems the RX/TX are swapped on some board revisions.  As far as I know GND is always the center pin.  If the above layout does not work, try plugging in the serial cable the other way around.

### xorg conf file:

    Section "Device"
            Identifier      "Video Device"
            Driver          "freedreno"
            # Uncomment for addition debug traces in xorg log:
            #Option          "Debug"           "true"
            # The below two options are not needed if you are using the
            # msm drm/kms driver:
            #Option          "fb"              "/dev/fb0"
            #Option           "SWCursor"        "true"
    EndSection
    Section "Screen"
            Identifier      "Screen"
            Monitor         "Monitor"
            Device          "Video Device"
    EndSection

### Compiling freedreno
See [[Build Instructions|Git-Trees-&-Branches#build-instructions]]

### Making NetworkManager behave

If NetworkManager is eating a lot of CPU, it is probably being confused by the rmnet devices. Ask it to ignore them in /etc/NetworkManager/NetworkManager.conf :

    [keyfile]
    unmanaged-devices=interface-name:rmnet0;interface-name:rmnet1;interface-name:rmnet2;interface-name:rmnet3;interface-name:rmnet4;interface-name:rmnet5;interface-name:rmnet6;interface-name:rmnet7;interface-name:rmnet_smux0